<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Agenda de Salas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial; }
    #calendar { max-width: 900px; margin: 40px auto; }
    @media (max-width: 576px) {
      #calendar { 
        max-width: 100vw; 
        margin: 0; 
        min-height: 80vh;   /* aumenta a altura mínima no mobile */
        height: 80vh !important; /* força altura maior no mobile */
      }
      .fc { font-size: 0.85rem; }
      .fc-timegrid-slot-label, .fc-col-header-cell { font-size: 0.8rem; }
      .fc-toolbar-title { font-size: 1rem; }
      .fc-scrollgrid-sync-table { min-width: 600px; }
      .container { padding: 0 !important; }
    }
  </style>
</head>
<body class="bg-light">

<div class="container">
  <div id="logout-area" class="text-end my-3" style="display:none;">
    <button onclick="logout()" class="btn btn-outline-danger">Sair</button>
  </div>

  <div id="calendar"></div>

  <div id="admin-area" style="display:none">
    <div class="row justify-content-center">
      <div class="col-12">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h2 class="card-title text-center mb-4">Admin - Todos os eventos</h2>
            <div class="table-responsive">
              <table id="tabela-eventos" class="table table-bordered table-striped"></table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
<script>
  // Autenticação simples
  const usuario = localStorage.getItem("usuario");
  const tipo = localStorage.getItem("tipo");
  if (!usuario) window.location.href = "index.html";

  const firebaseConfig = {
    apiKey: "AIzaSyCCdRJmIkj7ESK58waFzZlTxAaU9Ahy99E",
    authDomain: "agenda-impressoras.firebaseapp.com",
    projectId: "agenda-impressoras",
    storageBucket: "agenda-impressoras.firebasestorage.app",
    messagingSenderId: "664896537152",
    appId: "1:664896537152:web:76cb5e6fa3ec376a7f55a5",
    measurementId: "G-YPXD9VPDFT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth(); // Adicione esta linha

  let currentUser = usuario;
  let currentTipo = tipo;
  let calendar = null;

  // Cores para cada impressora
  const impressoraCores = {
    "Impressora 1 (esquerda)": "#007bff",
    "Impressora 2 (direita)": "#28a745"
  };

  document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("logout-area").style.display = "block";
    if (currentTipo === "admin") document.getElementById("admin-area").style.display = "block";
    initCalendar();
    if (currentTipo === "admin") carregarTodosEventos();
  });

  function logout() {
    localStorage.removeItem("usuario");
    localStorage.removeItem("tipo");
    window.location.href = "index.html";
  }

  function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (calendar) calendar.destroy();
    let initialView = window.innerWidth < 576 ? 'timeGridDay' : 'timeGridWeek';
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: initialView,
      locale: 'pt-br',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      selectable: false, // Não permite selecionar intervalo vazio arrastando
      editable: true,    // Permite arrastar/mover apenas eventos já cadastrados
      eventStartEditable: true,
      eventDurationEditable: true,
      // Ao clicar em um dia no mês ou semana, vai para o dia
      dateClick: function(info) {
        // Se estiver no dayview, abre o modal para o horário clicado
        if (calendar.view.type === 'timeGridDay') {
          // Define um intervalo padrão de 30 minutos
          const start = info.date;
          const end = new Date(start.getTime() + 30 * 60000);
          abrirModalEvento(
            start,
            end,
            function(evento) {
              db.collection("eventos").add(evento).then(() => {
                calendar.refetchEvents();
                if (currentTipo === "admin") carregarTodosEventos();
              });
            }
          );
        }
        // Se estiver no mês ou semana, muda para o dia
        else if (calendar.view.type === 'dayGridMonth' || calendar.view.type === 'timeGridWeek') {
          calendar.changeView('timeGridDay', info.dateStr);
        }
      },
      eventClick: function(info) {
        const evento = info.event;
        if (currentTipo === "admin" || evento.extendedProps.user === currentUser) {
          if (confirm("Deseja excluir este evento?")) {
            if (evento.id) {
              db.collection("eventos").doc(evento.id).delete().then(() => {
                calendar.refetchEvents();
                if (currentTipo === "admin") carregarTodosEventos();
              });
            }
          }
        } else {
          alert("Você só pode alterar eventos criados por você.");
        }
      },
      eventDrop: function(info) {
        const evento = info.event;
        if (currentTipo === "admin" || evento.extendedProps.user === currentUser) {
          if (evento.id) {
            db.collection("eventos").doc(evento.id).update({
              start: evento.startStr,
              end: evento.endStr
            }).then(() => {
              calendar.refetchEvents();
              if (currentTipo === "admin") carregarTodosEventos();
            });
          }
        } else {
          alert("Você só pode mover eventos criados por você.");
          info.revert();
        }
      },
      events: function(fetchInfo, successCallback, failureCallback) {
        db.collection("eventos").get()
          .then(snapshot => {
            const eventos = snapshot.docs.map(doc => {
              const data = doc.data();
              return {
                id: doc.id,
                title: `${data.nome} - ${data.impressora} - ${data.user}`, // Exibe nome, impressora e usuário
                start: data.start,
                end: data.end,
                user: data.user,
                impressora: data.impressora,
                color: impressoraCores[data.impressora] || "#6c757d" // Cor por impressora
              };
            });
            successCallback(eventos);
          })
          .catch(failureCallback);
      }
    });
    calendar.render();
  }

  function carregarTodosEventos() {
    const tabela = document.getElementById("tabela-eventos");
    tabela.innerHTML = "<tr><th>Usuário</th><th>Nome</th><th>Impressora</th><th>Início</th><th>Fim</th><th>Ações</th></tr>";
    db.collection("eventos").get().then(snapshot => {
      snapshot.forEach(doc => {
        const d = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.user}</td><td>${d.nome}</td><td>${d.impressora}</td><td>${d.start}</td><td>${d.end}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="excluirEventoAdmin('${doc.id}')">Excluir</button>
          </td>`;
        tabela.appendChild(tr);
      });
    });
  }

  function excluirEventoAdmin(id) {
    if (confirm("Deseja excluir este evento?")) {
      db.collection("eventos").doc(id).delete().then(() => {
        carregarTodosEventos();
        calendar.refetchEvents();
      });
    }
  }

  // Modal customizado para criar evento com seleção de horário
  function abrirModalEvento(startDate, endDate, onSave) {
    const oldModal = document.getElementById('modalEvento');
    if (oldModal) oldModal.remove();

    // Gera opções de horário a cada 30min
    function gerarOpcoesHorario() {
      let opcoes = '';
      for (let h = 7; h <= 22; h++) {
        for (let m = 0; m < 60; m += 30) {
          const hora = `${h.toString().padStart(2, '0')}:${m === 0 ? '00' : '30'}`;
          opcoes += `<option value="${hora}">${hora}</option>`;
        }
      }
      return opcoes;
    }

    // Extrai hora:minuto do Date
    function extrairHoraMinuto(dateObj) {
      return dateObj.toTimeString().slice(0,5);
    }

    // Data do evento
    const dataEvento = startDate instanceof Date ? startDate : new Date(startDate);

    const modalHtml = `
    <div class="modal fade" id="modalEvento" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formEvento">
            <div class="modal-header">
              <h5 class="modal-title">Novo Agendamento</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">Data:</label>
                <div><strong>${dataEvento.toLocaleDateString('pt-BR')}</strong></div>
              </div>
              <div class="mb-2">
                <label class="form-label">Horário de início:</label>
                <select class="form-select" id="horaInicio" required>
                  ${gerarOpcoesHorario()}
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Horário de término:</label>
                <select class="form-select" id="horaFim" required>
                  ${gerarOpcoesHorario()}
                </select>
              </div>
              <div class="mb-2">
                <label for="responsavelEvento" class="form-label">Nome do responsável:</label>
                <input type="text" class="form-control" id="responsavelEvento" required>
              </div>
              <div class="mb-2">
                <label for="impressoraEvento" class="form-label">Impressora:</label>
                <select class="form-select" id="impressoraEvento" required>
                  <option value="">Selecione...</option>
                  <option value="Impressora 1 (esquerda)">Impressora 1 (esquerda)</option>
                  <option value="Impressora 2 (direita)">Impressora 2 (direita)</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Salvar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Seleciona o horário mais próximo do clique
    document.getElementById('horaInicio').value = extrairHoraMinuto(startDate);
    document.getElementById('horaFim').value = extrairHoraMinuto(endDate);

    const modalEl = document.getElementById('modalEvento');
    const modal = new bootstrap.Modal(modalEl);
    modalEl.addEventListener('shown.bs.modal', () => {
      document.getElementById('responsavelEvento').focus();
    });
    modal.show();

    document.getElementById('formEvento').onsubmit = async function(e) {
      e.preventDefault();
      const responsavel = document.getElementById('responsavelEvento').value.trim();
      const impressora = document.getElementById('impressoraEvento').value;
      const data = dataEvento.toISOString().slice(0,10);
      const horaInicio = document.getElementById('horaInicio').value;
      const horaFim = document.getElementById('horaFim').value;
      if (!responsavel || !impressora) return;

      // Monta datas completas no formato ISO
      const start = `${data}T${horaInicio}:00`;
      const end = `${data}T${horaFim}:00`;

      // Verifica conflito de agendamento para a mesma impressora
      const snapshot = await db.collection("eventos")
        .where("impressora", "==", impressora)
        .where("start", "<", end)
        .get();

      // Agora filtra em JS pelo outro campo (end > start)
      const conflito = snapshot.docs.some(doc => {
        const evento = doc.data();
        return evento.end > start;
      });

      if (conflito) {
        alert("Já existe um agendamento para esta impressora neste horário.");
        return;
      }

      onSave({
        nome: responsavel,
        start: start,
        end: end,
        user: currentUser,
        impressora: impressora
      });
      modal.hide();
      setTimeout(() => {
        document.getElementById('modalEvento').remove();
      }, 500);
    };
  }

  function formatarHorario(str) {
    const d = new Date(str);
    return d.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
  }

  auth.onAuthStateChanged(function(user) {
    if (!user) {
      // Não autenticado, redireciona para login
      window.location.href = "index.html";
    }
  });
</script>
</body>
</html>